// TravelFlow - Multi-tenant SaaS for Travel Agencies
// Prisma Schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ========== TENANT MANAGEMENT ==========

model Tenant {
  id        String   @id @default(cuid())
  name      String
  logo      String?  // Cloud storage path
  email     String
  phone     String
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users       User[]
  clients     Client[]
  packages    Package[]
  seasons     Season[]
  destinations     Destination[]
  bookings         Booking[]
  suppliers        Supplier[]
  bankAccounts     BankAccount[]
  bankTransactions BankTransaction[]
  roles            Role[]
  invitations      Invitation[]
  auditLogs        AuditLog[]
  notifications    Notification[]
  supplierPayments SupplierPayment[]
  hotels           Hotel[]
  salesGoals       SalesGoal[]

  @@map("tenants")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  phone     String?
  tenantId  String
  role      String   @default("ADMIN")
  roleId    String?
  createdBy String?
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  roleRef Role?  @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([roleId])
  @@map("users")
}

// ========== CLIENT MANAGEMENT ==========

model Client {
  id        String    @id @default(cuid())
  tenantId  String
  fullName  String
  ine       String?
  passport  String?
  curp      String?
  phone     String
  email     String?
  birthDate DateTime?
  createdBy String?
  updatedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([tenantId])
  @@map("clients")
}

// ========== SEASON MANAGEMENT ==========

model Season {
  id          String   @id @default(cuid())
  tenantId    String
  name        String   // e.g., "Día de las Madres", "Semana Santa"
  description String   @default("") @db.Text
  color       String   @default("#3B82F6") // Visual identification color
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departures   PackageDeparture[]
  destinations Destination[]

  @@index([tenantId])
  @@map("seasons")
}

// ========== PACKAGE MANAGEMENT ==========

model Package {
  id                   String   @id @default(cuid())
  tenantId             String
  name                 String   // Destination name
  description          String   @db.Text
  images               String[] // Array of cloud storage paths
  servicesIncluded     String   @db.Text // JSON string
  servicesNotIncluded  String   @db.Text // JSON string
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departures PackageDeparture[]

  @@index([tenantId])
  @@map("packages")
}

model PackageDeparture {
  id             String   @id @default(cuid())
  packageId      String
  seasonId       String?  // Optional: assign to a season
  departureDate  DateTime
  returnDate     DateTime
  priceAdult     Float    @default(0)
  priceChild     Float    @default(0)
  availableSlots Int      @default(50)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  package  Package   @relation(fields: [packageId], references: [id], onDelete: Cascade)
  season   Season?   @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  bookings Booking[]

  @@index([packageId])
  @@index([seasonId])
  @@map("package_departures")
}

// ========== DESTINATION MANAGEMENT ==========

model Destination {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String   @default("") @db.Text
  seasonId    String?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  season   Season?   @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  bookings Booking[]
  hotels   Hotel[]

  @@index([tenantId])
  @@index([seasonId])
  @@map("destinations")
}

// ========== HOTEL MANAGEMENT ==========

model Hotel {
  id            String   @id @default(cuid())
  tenantId      String
  destinationId String
  name          String
  stars         Int      @default(0)
  diamonds      Int      @default(0)
  plan          String   @default("")
  roomType      String   @default("")
  checkIn       String   @default("")
  checkOut      String   @default("")
  checkInNote   String?  @db.Text
  checkOutNote  String?  @db.Text
  idRequirement String?  @db.Text
  includes      String[]
  notIncludes   String[]
  images        String[]
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  destination Destination   @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  bookings    Booking[]
  bookingItems BookingItem[]

  @@index([tenantId])
  @@index([destinationId])
  @@map("hotels")
}

// ========== SALES & PAYMENT MANAGEMENT ==========

model Booking {
  id               String   @id @default(cuid())
  tenantId         String
  clientId         String
  destinationId    String?
  totalPrice       Float
  netCost          Float    @default(0)
  paymentType      String   // CASH or CREDIT
  downPayment      Float    @default(0)
  numberOfPayments Int      @default(1)
  saleDate         DateTime @default(now())
  status           String   @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  notes            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Viaje - fechas y precios directos en la venta
  departureDate    DateTime?
  returnDate       DateTime?
  priceAdult       Float    @default(0)
  priceChild       Float    @default(0)
  numAdults        Int      @default(1)
  numChildren      Int      @default(0)
  pricePerNight    Float    @default(0)
  numNights        Int      @default(0)
  freeChildren     Int      @default(0)

  // Legacy fields (migración)
  packageId        String?
  departureId      String?

  supplierId       String?
  supplierDeadline DateTime?
  createdBy        String?
  updatedBy        String?

  // Quotation support
  type             String   @default("SALE") // SALE or QUOTATION
  expirationDate   DateTime?

  // Hotel
  hotelId          String?

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  destination      Destination?      @relation(fields: [destinationId], references: [id], onDelete: Restrict)
  departure        PackageDeparture? @relation(fields: [departureId], references: [id], onDelete: Restrict)
  supplier         Supplier?         @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  hotel            Hotel?            @relation(fields: [hotelId], references: [id], onDelete: SetNull)
  payments         PaymentPlan[]
  bankTransactions BankTransaction[]
  notifications    Notification[]
  supplierPayments SupplierPayment[]
  passengers       BookingPassenger[]
  items            BookingItem[]

  @@index([tenantId])
  @@index([clientId])
  @@index([destinationId])
  @@index([departureId])
  @@index([supplierId])
  @@index([hotelId])
  @@index([type])
  @@map("bookings")
}

// ========== BOOKING ITEMS (Services) ==========

model BookingItem {
  id          String   @id @default(cuid())
  bookingId   String
  type        String   // HOTEL, FLIGHT, TOUR, TRANSFER, OTHER
  description String?  @db.Text
  cost        Float    @default(0)
  sortOrder   Int      @default(0)

  // ── Hotel fields (type = HOTEL) ──
  hotelId       String?
  roomType      String?
  numAdults     Int?
  numChildren   Int?
  freeChildren  Int?
  pricePerNight Float?
  numNights     Int?
  plan          String?

  // ── Flight fields (type = FLIGHT) ──
  airline       String?
  flightNumber  String?
  origin        String?
  flightDestination String?
  departureTime DateTime?
  arrivalTime   DateTime?
  flightClass   String?
  direction     String?   // IDA, REGRESO

  // ── Tour fields (type = TOUR) ──
  tourName       String?
  tourDate       DateTime?
  numPeople      Int?
  pricePerPerson Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  hotel   Hotel?  @relation(fields: [hotelId], references: [id], onDelete: SetNull)

  @@index([bookingId])
  @@map("booking_items")
}

model BookingPassenger {
  id        String  @id @default(cuid())
  bookingId String
  name      String
  type      String  // ADULT, MINOR
  age       Int?
  isHolder  Boolean @default(false)

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("booking_passengers")
}

// ========== SUPPLIER MANAGEMENT ==========

model Supplier {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  phone       String
  email       String?
  serviceType String   @default("OTRO") // HOTEL, TRANSPORTE, TOUR, RESTAURANTE, OTRO
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings         Booking[]
  supplierPayments SupplierPayment[]

  @@index([tenantId])
  @@map("suppliers")
}

// ========== SUPPLIER PAYMENTS ==========

model SupplierPayment {
  id                String   @id @default(cuid())
  tenantId          String
  bookingId         String
  supplierId        String
  bankAccountId     String
  bankTransactionId String?  @unique
  amount            Float
  notes             String?  @db.Text
  date              DateTime @default(now())
  status            String   @default("ACTIVE") // ACTIVE, CANCELLED
  createdBy         String?
  createdAt         DateTime @default(now())

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking         Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  supplier        Supplier         @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  bankAccount     BankAccount      @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  bankTransaction BankTransaction? @relation(fields: [bankTransactionId], references: [id], onDelete: SetNull)

  @@index([tenantId, supplierId])
  @@index([bookingId])
  @@map("supplier_payments")
}

// ========== BANK MANAGEMENT ==========

model BankAccount {
  id              String   @id @default(cuid())
  tenantId        String
  bankName        String   // BBVA, Banorte, Santander, etc.
  accountNumber   String   // Numero de cuenta o CLABE
  accountType     String   // DEBITO, CREDITO, AHORRO
  referenceName   String   // Nombre de referencia (ej: "Cuenta principal")
  initialBalance  Float    @default(0)
  currentBalance  Float    @default(0)
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions     BankTransaction[]
  supplierPayments SupplierPayment[]

  @@index([tenantId])
  @@map("bank_accounts")
}

model BankTransaction {
  id                   String   @id @default(cuid())
  tenantId             String
  bankAccountId        String
  type                 String   // INCOME, EXPENSE, TRANSFER
  amount               Float
  description          String
  reference            String?  // Referencia opcional
  bookingId            String?  // Vinculado a una venta (opcional)
  destinationAccountId String?  // Para transferencias: cuenta destino
  status               String   @default("ACTIVE") // ACTIVE, CANCELLED
  date                 DateTime @default(now())
  createdAt            DateTime @default(now())

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bankAccount     BankAccount      @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  booking         Booking?         @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  supplierPayment SupplierPayment?

  @@index([tenantId])
  @@index([bankAccountId])
  @@index([bookingId])
  @@map("bank_transactions")
}

model PaymentPlan {
  id            String    @id @default(cuid())
  bookingId     String
  paymentNumber Int
  dueDate       DateTime
  amount        Float
  status        String    @default("PENDING") // PENDING, PAID, OVERDUE
  paidDate      DateTime?
  paidAmount    Float     @default(0)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([dueDate])
  @@map("payment_plans")
}

// ========== ROLES & PERMISSIONS ==========

model Role {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  permissions Json     // ["dashboard","clientes","ventas","bancos",...]
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users       User[]
  invitations Invitation[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

// ========== INVITATIONS ==========

model Invitation {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  token     String   @unique @default(uuid())
  roleId    String
  status    String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([token])
  @@map("invitations")
}

// ========== AUDIT LOG ==========

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  userName  String
  action    String   // CREATE, UPDATE, DELETE
  entity    String   // table name
  entityId  String
  changes   Json
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

// ========== NOTIFICATIONS ==========

model Notification {
  id        String   @id @default(cuid())
  tenantId  String
  bookingId String
  type      String   // SUPPLIER_DEADLINE
  message   String
  read      Boolean  @default(false)
  dismissed Boolean  @default(false)
  dueDate   DateTime
  createdAt DateTime @default(now())

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([bookingId])
  @@index([dueDate])
  @@map("notifications")
}

// ========== SALES GOALS ==========

model SalesGoal {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String
  month      Int
  year       Int
  goalAmount Float

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, month, year])
  @@index([tenantId])
  @@index([tenantId, year, month])
  @@map("sales_goals")
}
